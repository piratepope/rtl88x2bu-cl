name: Build OpenWrt x86 + RTL88x2BU

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - name: Install Dependencies
      run: |
        sudo apt update
        sudo apt install -y build-essential clang flex bison g++ gawk gcc-multilib g++-multilib gettext libncurses5-dev libssl-dev python3-setuptools rsync swig unzip zlib1g-dev file wget tree

    - name: Clone OpenWrt
      run: |
        git clone https://git.openwrt.org/openwrt/openwrt.git
        cd openwrt
        git checkout v23.05.3

    - name: Clone RTL88x2BU Driver
      run: |
        cd openwrt
        git clone https://github.com/mirobiala/rtl88x2bu-cl package/kernel/rtl88x2bu-cl
        cd package/kernel/rtl88x2bu-cl
        git checkout v1.3.1

    - name: Update & Install Feeds
      run: |
        cd openwrt
        ./scripts/feeds update -a
        ./scripts/feeds install -a

    - name: Apply Default Config
      run: |
        cd openwrt
        cat <<EOF > .config
CONFIG_TARGET_x86=y
CONFIG_TARGET_x86_64=y
CONFIG_TARGET_x86_64_DEVICE_generic=y
CONFIG_PACKAGE_kmod-rtl88x2bu-cl=m
CONFIG_PACKAGE_kmod-cfg80211=m
CONFIG_PACKAGE_iw=m
CONFIG_PACKAGE_wireless-regdb=m
CONFIG_PACKAGE_libiwinfo=m
CONFIG_PACKAGE_libiwinfo-data=m
CONFIG_PACKAGE_iwinfo=m
CONFIG_PACKAGE_usbutils=y
CONFIG_DEVEL=y
CONFIG_BUILD_LOG=y
CONFIG_KERNEL_DEVMEM=y
EOF
        make defconfig

    - name: Build OpenWrt
      run: |
        cd openwrt
        make -j$(nproc) V=s

    - name: Upload Image
      uses: actions/upload-artifact@v4
      with:
        name: openwrt-x86-rtl88x2bu
        path: openwrt/bin/targets/x86/64/*.img.gz
